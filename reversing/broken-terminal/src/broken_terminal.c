#include <stdio.h>
#include <sys/mman.h>
#include <stdint.h>
#include <time.h>
#include <stdlib.h>
#include <unistd.h>

#define FLAG_LEN 74

unsigned char what[] = "\x17\x0d\xce\xac\x06\xc7\x38\xaa\x0b\xcc\xb9\x00\xc7\xb1\x0c\xd3\x85\x45\x4f\x49\x4e\x06\xfd\x34\x2e\x24\x20\x67\x3a\x36\x31\x1b\xcb\x42\x0b\xc0\xb1\x06\x82\x94\x42\x45\x47\x49\x06\x89\x85\x50\x42\x45\x47\x46\x4b\x06\xcc\x95\x0e\xcc\xb9\x01\x89\x8c\x0f\x52\x42\x45\x0f\x8e\x8e\x4e\x45\x52\x42\x4a\x42\x01\x89\x8d\x45\x52\x42\x45\x0f\xca\xb5\x07\x4a\xdf\xd4\x45\x47\x49\x06\x89\x82\x52\x42\x45\x47\x01\x89\x8e\x7c\x52\x42\x45\x48\x4c\x06\xcd\xbd\x52\x36\x40\x0f\xb6\x8d\xa5\x9e\x1f\xcb\xb0\x0e\xc8\x8b\x4e\x4c\x52\x42\x0c\x46\x97\x0f\xc4\x43\x1a\x85\x84\x23\x49\x4e\x4e\xb3\xa3\x03\xcd\x02\x49\xc6\xae\x0d\x95\x83\x55\x60\x49\x4e\x06\xb2\xb3\x0b\xc6\x82\x41\x07\xc7\x00\x52\x0b\xc6\xaa\x41\x02\xc7\xaa\x1a\x85\x83\x47\x49\x4e\x4e\x0d\x95\x82\x66\x47\x49\x4e\x41\x40\x1a\xc1\xbd\x47\x3c\xfc\x06\x82\x95\x42\x45\x47\x49\x02\xc7\xbb\x1a\x43\x9b\x0f\x8e\x8c\x4f\x45\x52\x42\x0d\x80\x89\x4f\x4e\x45\x52\x4d\x40\x0f\x8e\x8e\x72\x45\x52\x42\x0d\x80\x8e\x4e\x4e\x45\x52\x4d\x40\xac\xb7\xde\x13\x86\x34\x6c\x4a\x58\xcd\x4e\x4e\x45\x52";

void setup_worker(uint64_t seed);
void worker(unsigned char * wait_arr);

int main() {
	union Data {
		char buf[FLAG_LEN];
		uint64_t seed;
	} u;

	alarm(5);

	setvbuf(stdout, NULL, _IONBF, 0);
	FILE * f = fopen("flag.txt", "r");

	srand(time(NULL));
	u.seed = rand();

	fgets(u.buf, FLAG_LEN, f);

	setup_worker(u.seed);
}

void setup_worker(uint64_t seed) {
	unsigned char * base = mmap(0, 0x1000, PROT_READ | PROT_EXEC | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, -1, 0);

	for (int i = 0 ; i < 0x200 / 8 ; i++) {
		((unsigned long * )base)[i] = seed ^ ((unsigned long *)what)[i];
	}

	((void (*)(void *))base)(what);
}

